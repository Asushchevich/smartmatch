<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SmartMatch - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        form { display: flex; flex-direction: column; gap: 12px; }

        input, button {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover { opacity: 0.9; }

        .login-btn { background: #007bff; }
        .refresh-btn { background: #6c757d; margin-bottom: 15px; }
        .finish-btn { background: #dc3545; padding: 6px 12px; font-size: 12px; }

        #tokenArea {
            word-break: break-all;
            color: #666;
            font-size: 11px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .match-item {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-info b { font-size: 16px; color: #222; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
            margin-top: 5px;
        }

        .status-SCHEDULED { background: #fff3cd; color: #856404; }
        .status-FINISHED { background: #d4edda; color: #155724; }

        #authSection { display: flex; gap: 20px; justify-content: center; }
        @media (max-width: 600px) { #authSection { flex-direction: column; } }
    </style>
</head>
<body>

<div class="container">
    <div id="authSection">
        <div class="card" style="flex: 1;">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <form id="regForm">
                <input id="regUser" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required type="text">
                <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å" required type="password">
                <button type="submit">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </form>
        </div>

        <div class="card" style="flex: 1;">
            <h2>–í—Ö–æ–¥</h2>
            <form id="loginForm">
                <input id="loginUser" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required type="text">
                <input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" required type="password">
                <button class="login-btn" type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <div id="tokenArea"></div>
        </div>
    </div>

    <div id="dashboard" class="card" style="display: none;">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞–º–∏</h2>
        <button class="refresh-btn" onclick="loadMatches()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="matchesContainer">
            <p style="color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</p>
        </div>
    </div>
</div>

<script>
    const AUTH_URL = '/api/v1/auth';
    const MATCH_URL = '/api/v1/matches';

    // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${AUTH_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: document.getElementById('regUser').value,
                    password: document.getElementById('regPass').value,
                    role: 'ROLE_ADMIN', // –î–ª—è —Ç–µ—Å—Ç–æ–≤ —Å—Ç–∞–≤–∏–º ADMIN
                    enabled: true
                })
            });
            const text = await res.text();
            alert(text);
        } catch (err) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
    };

    // –í–•–û–î
    document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${AUTH_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: document.getElementById('loginUser').value,
                    password: document.getElementById('loginPass').value
                })
            });
            if (res.ok) {
                const token = await res.text();
                localStorage.setItem('token', token);

                const area = document.getElementById('tokenArea');
                area.style.display = 'block';
                area.innerText = "JWT: " + token.substring(0, 30) + "...";

                showDashboard();
            } else { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!'); }
        } catch (err) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
    };

    // –ó–ê–ì–†–£–ó–ö–ê –ú–ê–¢–ß–ï–ô
    async function loadMatches() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch(MATCH_URL, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');

            const matches = await res.json();
            const container = document.getElementById('matchesContainer');

            if (matches.length === 0) {
                container.innerHTML = '<p>–ú–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                return;
            }

            container.innerHTML = matches.map(m => `
                <div class="match-item">
                    <div class="match-info">
                        <b>${m.teamA} ‚Äî ${m.teamB}</b><br>
                        <span class="status-badge status-${m.status}">${m.status}</span>
                    </div>
                    <div>
                        ${m.status === 'SCHEDULED' ?
                `<button class="finish-btn" onclick="finishMatch('${m.id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á</button>` :
                '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω'}
                    </div>
                </div>
            `).join('');
        } catch (err) {
            console.error(err);
            document.getElementById('matchesContainer').innerHTML = '<p style="color:red">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (403/500)</p>';
        }
    }

    // –ó–ê–í–ï–†–®–ï–ù–ò–ï –ú–ê–¢–ß–ê (–¢—Ä–∏–≥–≥–µ—Ä RabbitMQ)
    async function finishMatch(id) {
        const token = localStorage.getItem('token');
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏!')) return;

        try {
            const res = await fetch(`${MATCH_URL}/${id}/status?status=FINISHED`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                loadMatches(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                alert('–û—à–∏–±–∫–∞: –≤–æ–∑–º–æ–∂–Ω–æ, —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ ADMIN');
            }
        } catch (err) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞'); }
    }

    function showDashboard() {
        document.getElementById('dashboard').style.display = 'block';
        loadMatches();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    window.onload = () => {
        if (localStorage.getItem('token')) { showDashboard(); }
    };
</script>
</body>
</html>