<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SmartMatch Pro | Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --bg: #f0f2f5; --card: #ffffff; --primary: #1a73e8;
            --success: #34a853; --danger: #ea4335; --warning: #fbbc05;
            --text: #202124; --text-light: #5f6368;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1000px; }
        .card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 20px; }
        .hidden { display: none !important; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #dadce0; background: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .match-item { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 20px; padding: 15px; border-bottom: 1px solid #eee; }
        .team-name { font-size: 18px; font-weight: bold; }
        .score-box { background: #3c4043; color: white; padding: 10px 20px; border-radius: 8px; font-size: 24px; font-weight: 800; min-width: 80px; text-align: center; }

        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .LIVE { background: #e6f4ea; color: var(--success); border: 1px solid var(--success); }
        .SCHEDULED { background: #fef7e0; color: #b06000; border: 1px solid var(--warning); }
        .FINISHED { background: #f1f3f4; color: var(--text-light); }
        .CANCELLED { background: #fce8e6; color: var(--danger); }

        .manage-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 30px; text-align: center; align-items: center; }
        .score-btn-group { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }

        .toast { position: fixed; top: 20px; right: 20px; background: #323232; color: white; padding: 16px; border-radius: 8px; z-index: 1000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-page" class="card">
        <h2 id="auth-title">SmartMatch Login</h2>
        <input id="username" type="text" placeholder="Username">
        <input id="password" type="password" placeholder="Password">
        <button id="auth-btn" class="btn-primary" style="width:100%" onclick="handleAuth()">Login</button>
        <p style="text-align:center"><a href="#" onclick="toggleAuthMode()" id="auth-toggle-text">Create Admin Account</a></p>
    </div>

    <div id="list-page" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h1>üèÜ Dashboard <span id="ws-status" style="font-size: 12px; color: var(--danger)">‚óè Offline</span></h1>
            <button class="btn-outline" onclick="logout()">Logout</button>
        </div>

        <div class="card" style="border-left: 6px solid var(--primary);">
            <h3 style="margin-top:0">Schedule New Match</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:10px; align-items: end;">
                <div><label>Home</label><input id="new-home" placeholder="Team A"></div>
                <div><label>Away</label><input id="new-away" placeholder="Team B"></div>
                <div><label>Date</label><input type="datetime-local" id="new-date"></div>
                <div><label>Sport</label>
                    <select id="new-sport">
                        <option value="FOOTBALL">‚öΩ Football</option>
                        <option value="BASKETBALL">üèÄ Basketball</option>
                    </select>
                </div>
                <button class="btn-success" onclick="createMatch()">Create</button>
            </div>
        </div>

        <div class="tabs">
            <button id="tab-FOOTBALL" class="tab-btn active" onclick="switchTab('FOOTBALL')">‚öΩ Football</button>
            <button id="tab-BASKETBALL" class="tab-btn" onclick="switchTab('BASKETBALL')">üèÄ Basketball</button>
        </div>

        <div id="match-container"></div>
    </div>

    <div id="manage-page" class="card hidden">
        <button class="btn-outline" onclick="showListPage()">‚Üê Back to List</button>
        <div id="manage-content" style="margin-top:20px">
            <div class="manage-grid">
                <div class="score-btn-group" id="home-score-ctrl"></div>

                <div>
                    <div id="m-status" class="badge">STATUS</div>
                    <div id="m-sport-icon" style="font-size: 24px; margin: 10px 0;">‚öΩ</div>
                    <h1 id="m-teams" style="font-size:32px">Team A vs Team B</h1>
                    <div id="m-score" style="font-size:64px; font-weight:800">0 : 0</div>
                </div>

                <div class="score-btn-group" id="away-score-ctrl"></div>
            </div>

            <div style="margin-top:40px; padding-top:20px; border-top:1px solid #eee">
                <h3>Update Match Status</h3>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="btn-primary" style="background:var(--warning); color:black" onclick="changeStatus('SCHEDULED')">Set Scheduled</button>
                    <button class="btn-success" onclick="changeStatus('LIVE')">Set Live (Start)</button>
                    <button class="btn-primary" style="background:#3c4043" onclick="changeStatus('FINISHED')">Set Finished</button>
                    <button class="btn-danger" onclick="changeStatus('CANCELLED')">Set Cancelled</button>
                    <button class="btn-outline" style="border-color:var(--danger); color:var(--danger)" onclick="deleteMatch()">Delete Match</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = '/api/v1';
    let isLogin = true;
    let selectedId = null;
    let stompClient = null;
    let currentTab = 'FOOTBALL';
    let allMatches = [];

    // --- WebSocket ---
    function connectWebSocket() {
        if (stompClient && stompClient.connected) return;
        const socket = new SockJS('http://localhost:8080/ws-notifications');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            document.getElementById('ws-status').innerText = '‚óè Live';
            document.getElementById('ws-status').style.color = 'var(--success)';

            stompClient.subscribe('/topic/match-updates', function (msg) {
                const event = JSON.parse(msg.body);
                showToast(event.message || "Match Updated!");
                fetchMatches();
                if (selectedId === event.matchId) fetchSingleMatch();
            });
        }, function () {
            document.getElementById('ws-status').innerText = '‚óè Reconnecting...';
            setTimeout(connectWebSocket, 5000);
        });
    }

    function showToast(text) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `<strong>SmartMatch:</strong><br>${text}`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    // --- Auth ---
    async function handleAuth() {
        const userVal = document.getElementById('username').value;
        const passVal = document.getElementById('password').value;
        const payload = { username: userVal, password: passVal };
        if(!isLogin) payload.role = 'ROLE_ADMIN';

        const res = await fetch(`${API}/auth/${isLogin?'login':'register'}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            if (isLogin) {
                const token = await res.text();
                localStorage.setItem('token', token);
                showListPage();
            } else {
                alert('Success! Now login.');
                toggleAuthMode();
            }
        } else alert('Auth Failed.');
    }

    function toggleAuthMode() {
        isLogin = !isLogin;
        document.getElementById('auth-title').innerText = isLogin ? 'SmartMatch Login' : 'Register Admin';
        document.getElementById('auth-btn').innerText = isLogin ? 'Login' : 'Sign Up';
    }

    // --- Navigation & Tabs ---
    function showListPage() {
        selectedId = null;
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('manage-page').classList.add('hidden');
        document.getElementById('list-page').classList.remove('hidden');
        fetchMatches();
        connectWebSocket();
    }

    function switchTab(sport) {
        currentTab = sport;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${sport}`).classList.add('active');
        renderList();
    }

    // --- API Calls ---
    async function fetchMatches() {
        const res = await fetch(`${API}/matches`, {
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
        if (res.ok) {
            allMatches = await res.json();
            renderList();
        }
    }

    function renderList() {
        const container = document.getElementById('match-container');
        const filtered = allMatches.filter(m => (m.sportType || 'FOOTBALL') === currentTab);

        if(filtered.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:gray; margin-top:20px;">No matches found for ${currentTab}</p>`;
            return;
        }

        container.innerHTML = filtered.map(m => `
            <div class="card match-item">
                <div class="team-name" style="text-align:right">${m.teamA || m.homeTeam}</div>
                <div style="text-align:center">
                    <div class="score-box">${m.home_team_score ?? 0} : ${m.away_team_score ?? 0}</div>
                    <div class="badge ${m.status}" style="margin-top:10px">${m.status}</div>
                </div>
                <div class="team-name">${m.teamB || m.awayTeam}</div>
                <div style="grid-column: span 3; text-align:center; margin-top:10px">
                    <button class="btn-outline" onclick="openManage('${m.id}')">Manage</button>
                </div>
            </div>
        `).join('');
    }

    async function createMatch() {
        const home = document.getElementById('new-home').value;
        const away = document.getElementById('new-away').value;
        const dateInput = document.getElementById('new-date').value;
        const sport = document.getElementById('new-sport').value;

        if (!home || !away || !dateInput) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –∫–æ–º–∞–Ω–¥—ã –∏ –¥–∞—Ç—É!");
            return;
        }

        const formattedDate = dateInput.includes(':') && dateInput.split(':').length === 2
            ? dateInput + ':00'
            : dateInput;

        const body = {
            teamA: home,
            teamB: away,
            start_date: formattedDate,
            sportType: sport,
            status: 'SCHEDULED',
            home_team_score: 0,
            away_team_score: 0
        };

        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON:", body);

        const res = await fetch(`${API}/matches`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            document.getElementById('new-home').value = '';
            document.getElementById('new-away').value = '';
            document.getElementById('new-date').value = '';

            await fetchMatches();
            alert("–ú–∞—Ç—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
        } else {
            const errorText = await res.text();
            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errorText);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: " + errorText);
        }
    }

    async function openManage(id) {
        selectedId = id;
        document.getElementById('list-page').classList.add('hidden');
        document.getElementById('manage-page').classList.remove('hidden');
        fetchSingleMatch();
    }

    async function fetchSingleMatch() {
        if(!selectedId) return;
        const res = await fetch(`${API}/matches/${selectedId}`, {
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
        if (res.ok) {
            const m = await res.json();
            const sport = m.sportType || 'FOOTBALL';
            document.getElementById('m-teams').innerText = `${m.teamA} vs ${m.teamB}`;
            document.getElementById('m-score').innerText = `${m.home_team_score} : ${m.away_team_score}`;
            document.getElementById('m-sport-icon').innerText = sport === 'BASKETBALL' ? 'üèÄ' : '‚öΩ';

            const badge = document.getElementById('m-status');
            badge.innerText = m.status;
            badge.className = `badge ${m.status}`;

            // –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–º
            renderScoreButtons(sport);
        }
    }

    function renderScoreButtons(sport) {
        const createBtns = (side) => {
            if (sport === 'BASKETBALL') {
                return `
                    <button class="btn-success btn-circle" onclick="updateScore('${side}', 'goal', 1)">+1</button>
                    <button class="btn-success btn-circle" onclick="updateScore('${side}', 'goal', 2)">+2</button>
                    <button class="btn-success btn-circle" onclick="updateScore('${side}', 'goal', 3)">+3</button>
                    <button class="btn-primary" onclick="updateScore('${side}', 'goal-cancel')">‚àí Undo</button>
                `;
            }
            return `
                <button class="btn-success btn-circle" onclick="updateScore('${side}', 'goal', 1)">+</button>
                <button class="btn-primary" onclick="updateScore('${side}', 'goal-cancel')">‚àí Undo</button>
            `;
        };
        document.getElementById('home-score-ctrl').innerHTML = createBtns('HOME');
        document.getElementById('away-score-ctrl').innerHTML = createBtns('AWAY');
    }

    async function updateScore(side, endpoint, pts = 1) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–æ—Ä—Ç –¥–ª—è API
        const sport = allMatches.find(m => m.id === selectedId)?.sportType || 'FOOTBALL';
        await fetch(`${API}/matches/${selectedId}/${endpoint}?teamSide=${side}&sportType=${sport}&points=${pts}`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
    }

    async function changeStatus(status) {
        await fetch(`${API}/matches/${selectedId}/status?status=${status}`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
    }

    async function deleteMatch() {
        if(confirm('Delete?')) {
            await fetch(`${API}/matches/${selectedId}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
            });
            showListPage();
        }
    }

    function logout() { localStorage.clear(); location.reload(); }
    if (localStorage.getItem('token')) showListPage();
</script>
</body>
</html>