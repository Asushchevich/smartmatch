<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SmartMatch Pro</title>
    <style>
        :root {
            --primary: #007bff; --success: #28a745; --danger: #dc3545;
            --warning: #ffc107; --gray: #6c757d; --dark: #343a40;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 40px 20px; }
        .container { width: 100%; max-width: 900px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .hidden { display: none !important; }

        button { padding: 12px 20px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-login { background: var(--primary); width: 100%; }
        .btn-reg { background: var(--success); width: 100%; }
        .btn-delete { background: transparent; color: var(--danger); padding: 5px 10px; font-size: 12px; border:none; cursor:pointer;}
        .btn-delete:hover { text-decoration: underline; }

        .status-label { padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .status-SCHEDULED { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-LIVE { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; animation: pulse-green 2s infinite; }
        .status-FINISHED { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
        .status-CANCELLED { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; text-decoration: line-through; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .score-big { font-size: 48px; font-weight: bold; margin: 20px 0; display: flex; align-items: center; gap: 30px; justify-content: center; }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .btn-plus { background: var(--success); width: 70px; height: 70px; border-radius: 50%; font-size: 30px; }
        .btn-minus { background: var(--danger); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; }
        .btn-back { background: transparent; color: var(--primary); border: 2px solid var(--primary); margin-bottom: 20px; }

        .match-card { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }

        .create-form { display: grid; grid-template-columns: 1fr 1fr 180px 140px auto; gap: 10px; align-items: end; }
        .create-form label { display: block; font-size: 11px; color: var(--gray); margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .create-form input, .create-form select { margin-bottom: 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-page" class="card">
        <h2 id="auth-title">–í—Ö–æ–¥ –≤ SmartMatch</h2>
        <form id="auth-form">
            <input id="username" type="text" placeholder="–õ–æ–≥–∏–Ω" required>
            <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button type="submit" id="main-auth-btn" class="btn-login">–í–æ–π—Ç–∏</button>
        </form>
        <p style="text-align:center; margin-top:15px;">
            <a href="#" id="toggle-auth" style="color: var(--primary); text-decoration:none;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </p>
    </div>

    <div id="list-page" class="hidden">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>–°–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π</h2>
            <button onclick="logout()" style="background:var(--danger)">–í—ã–π—Ç–∏</button>
        </div>

        <div class="card" style="border-top: 4px solid var(--success); padding: 20px;">
            <h4 style="margin-top:0; margin-bottom:15px">üÜï –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ç—á</h4>
            <div class="create-form">
                <div>
                    <label>–•–û–ó–Ø–ï–í–ê</label>
                    <input type="text" id="new-teamA" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                <div>
                    <label>–ì–û–°–¢–ò</label>
                    <input type="text" id="new-teamB" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                <div>
                    <label>–î–ê–¢–ê –ò –í–†–ï–ú–Ø</label>
                    <input type="datetime-local" id="new-startDate">
                </div>
                <div>
                    <label>–°–ü–û–†–¢</label>
                    <select id="new-sportType">
                        <option value="FOOTBALL">–§—É—Ç–±–æ–ª</option>
                        <option value="BASKETBALL">–ë–∞—Å–∫–µ—Ç–±–æ–ª</option>
                    </select>
                </div>
                <button class="btn-reg" onclick="handleCreateMatch()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>

        <div id="match-list-container"></div>
    </div>

    <div id="manage-page" class="card hidden">
        <button class="btn-back" onclick="showListPage()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
        <div id="manage-details" style="text-align: center;">
            <h1 id="teams-title">Team A vs Team B</h1>
            <div id="current-status" class="status-label">STATUS</div>

            <div id="score-controls" class="score-big">
                <div class="control-group">
                    <button class="btn-plus" onclick="handleGoal('HOME')">+</button>
                    <button class="btn-minus" onclick="handleGoalCancel('HOME')">‚àí</button>
                </div>
                <span id="live-score">0 : 0</span>
                <div class="control-group">
                    <button class="btn-plus" onclick="handleGoal('AWAY')">+</button>
                    <button class="btn-minus" onclick="handleGoalCancel('AWAY')">‚àí</button>
                </div>
            </div>

            <div id="status-actions" style="display:flex; gap:10px; justify-content: center; margin-top: 20px;">
                <button id="btn-start" class="btn-login" style="width:auto" onclick="handleStatus('LIVE')">‚ñ∂ –ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>
                <button id="btn-finish" style="background:var(--dark); width:auto" onclick="handleStatus('FINISHED')">‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                <button id="btn-cancel" style="background:var(--gray); width:auto" onclick="handleStatus('CANCELLED')">‚úñ –û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API = '/api/v1';
    let isLoginMode = true;
    let selectedMatchId = null;

    document.getElementById('toggle-auth').onclick = (e) => {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? '–í—Ö–æ–¥ –≤ SmartMatch' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ADMIN';
        document.getElementById('main-auth-btn').innerText = isLoginMode ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
        document.getElementById('main-auth-btn').className = isLoginMode ? 'btn-login' : 'btn-reg';
        e.target.innerText = isLoginMode ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
    };

    document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const path = isLoginMode ? '/auth/login' : '/auth/register';
        const payload = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value
        };
        if(!isLoginMode) { payload.role = 'ROLE_ADMIN'; payload.enabled = true; }

        try {
            const res = await fetch(API + path, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                if (isLoginMode) {
                    localStorage.setItem('token', await res.text());
                    showListPage();
                } else {
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
                    location.reload();
                }
            } else { alert('–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.'); }
        } catch (err) { alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
    };

    async function showListPage() {
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('manage-page').classList.add('hidden');
        document.getElementById('list-page').classList.remove('hidden');

        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/matches`, { headers: {'Authorization': `Bearer ${token}`} });
        const matches = await res.json();

        document.getElementById('match-list-container').innerHTML = matches.map(m => {
            const dateStr = m.start_date || m.startDate;
            const date = dateStr ? new Date(dateStr).toLocaleString('ru', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';

            return `
            <div class="card match-card" style="border-left: 8px solid ${getStatusColor(m.status)}">
                <div>
                    <small style="color:var(--gray)">${date}</small><br>
                    <strong>${m.teamA} vs ${m.teamB}</strong><br>
                    <span class="status-label status-${m.status}">${m.status}</span>
                </div>
                <div style="text-align: right;">
                    <div style="font-size:24px; font-weight:bold">${m.home_team_score ?? 0} : ${m.away_team_score ?? 0}</div>
                    <button class="btn-login" style="width:auto; padding: 5px 15px;" onclick="openManage('${m.id}')">–£–ø—Ä–∞–≤–ª—è—Ç—å</button>
                    <br><button class="btn-delete" onclick="handleDeleteMatch('${m.id}')">—É–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `}).join('');
    }

    async function handleCreateMatch() {
        const teamA = document.getElementById('new-teamA').value;
        const teamB = document.getElementById('new-teamB').value;
        const startDate = document.getElementById('new-startDate').value;
        const sportType = document.getElementById('new-sportType').value;

        if (!teamA || !teamB || !startDate) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');

        if (new Date(startDate) <= new Date()) {
            return alert('–ú–∞—Ç—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ –±—É–¥—É—â–µ–µ –≤—Ä–µ–º—è!');
        }

        const token = localStorage.getItem('token');

        const body = {
            teamA: teamA,
            teamB: teamB,
            start_date: startDate,
            sportType: sportType,
            title: `${teamA} vs ${teamB}`,
            status: 'SCHEDULED',
            home_team_score: 0,
            away_team_score: 0
        };

        const res = await fetch(`${API}/matches`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            document.getElementById('new-teamA').value = '';
            document.getElementById('new-teamB').value = '';
            document.getElementById('new-startDate').value = '';
            showListPage();
        } else {
            const err = await res.json();
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + (err.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'));
        }
    }

    async function handleDeleteMatch(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á?')) return;
        const token = localStorage.getItem('token');
        await fetch(`${API}/matches/${id}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`}
        });
        showListPage();
    }

    function getStatusColor(status) {
        switch(status) {
            case 'LIVE': return '#28a745';
            case 'SCHEDULED': return '#ffc107';
            case 'CANCELLED': return '#dc3545';
            default: return '#6c757d';
        }
    }

    async function openManage(id) {
        selectedMatchId = id;
        document.getElementById('list-page').classList.add('hidden');
        document.getElementById('manage-page').classList.remove('hidden');
        refreshManageData();
    }

    async function refreshManageData() {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/matches/${selectedMatchId}`, { headers: {'Authorization': `Bearer ${token}`} });
        const m = await res.json();

        document.getElementById('teams-title').innerText = `${m.teamA} vs ${m.teamB}`;
        const badge = document.getElementById('current-status');
        badge.innerText = m.status;
        badge.className = `status-label status-${m.status}`;

        document.getElementById('live-score').innerText = `${m.home_team_score ?? 0} : ${m.away_team_score ?? 0}`;

        const scoreControls = document.getElementById('score-controls');
        const btnStart = document.getElementById('btn-start');
        const btnFinish = document.getElementById('btn-finish');
        const btnCancel = document.getElementById('btn-cancel');

        if (m.status === 'LIVE') {
            scoreControls.classList.remove('hidden');
            btnStart.classList.add('hidden');
            btnFinish.classList.remove('hidden');
            btnCancel.classList.remove('hidden');
        } else if (m.status === 'SCHEDULED') {
            scoreControls.classList.add('hidden');
            btnStart.classList.remove('hidden');
            btnFinish.classList.add('hidden');
            btnCancel.classList.remove('hidden');
        } else {
            scoreControls.classList.add('hidden');
            document.getElementById('status-actions').classList.add('hidden');
        }
    }

    async function handleGoal(side) {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/matches/${selectedMatchId}/goal?sportType=FOOTBALL&teamSide=${side}`, {
            method: 'PATCH', headers: {'Authorization': `Bearer ${token}`}
        });
        if(res.ok) refreshManageData();
    }

    async function handleGoalCancel(side) {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/matches/${selectedMatchId}/goal-cancel?sportType=FOOTBALL&teamSide=${side}`, {
            method: 'PATCH', headers: {'Authorization': `Bearer ${token}`}
        });
        if(res.ok) refreshManageData();
    }

    async function handleStatus(status) {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/matches/${selectedMatchId}/status?status=${status}`, {
            method: 'PATCH', headers: {'Authorization': `Bearer ${token}`}
        });
        if(res.ok) refreshManageData();
    }

    function logout() { localStorage.clear(); location.reload(); }
    if (localStorage.getItem('token')) showListPage();
</script>
</body>
</html>